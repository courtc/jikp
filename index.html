<!DOCTYPE html>
<html>
    <meta name="viewport" 
        content="width=device-width, initial-scale=1.0, user-scalable=no">
	<head>
		<title>IK+ Revival</title>	
		
		<style>
			@font-face {
				font-family: "C64 Pro Mono";
				src: url("gfx/C64_Pro_Mono_v1.0-STYLE.ttf") format("truetype");
			}
			body {
				background-color:#000;
				margin:0 0 0 0;
				padding: 0 0 0 0;
				overflow: hidden;
				font: normal 24pt/32px "C64 Pro Mono", verdana, helvetica, sans-serif;
			}
		</style>
		
	</head>
	<body>
	
	
	<script>
        var anim_walk = [35,36,37,38,39,40];
        var anim_idle = [0];
        var anim_headbutt = [1,2,1];
        var anim_kick_high = [4,5,6];
        var anim_fall = [7,8,9,10,11,12,35,35,35,35];
        var anim_cartwheel = [21,22,23,24,25,26];
        var anim_jump = [13,14,14,14,13];
        var anim_jumpkick = [13,14,15,15,13];
        var anim_punch = [19,20];
        var anim_kick = [28,29,30,31];
        var anim_low_kick = [0];
        var anim_sweep = [16, 17, 18];
        var anim_block = [0];
        var anim_splitkick = [32,33,34,33,32];
        var anim_sit_punch = [0];
        var anim_k = [0];
        var anim_ki = [0];
        var anim_demo = [0,0,0,0,21,22,23,24,25,26,35,35,1,2,1,35,4,5,6,35,35,0,0,0,0];

        var anim_sweep_back = anim_sweep;
        var anim_punch_back = anim_punch;
        var anim_kick_high_back = anim_kick_high;

	var KEYCODE_SHIFT = 16;
	var KEYCODE_SPACE = 32;
	var KEYCODE_CTRL = 17;
	var KEYCODE_UP = 38;
	var KEYCODE_DOWN = 40;
	var KEYCODE_LEFT = 37;
	var KEYCODE_RIGHT = 39;
	var KEYCODE_W = 87;
	var KEYCODE_A = 65;
	var KEYCODE_S = 83;
	var KEYCODE_D = 68;        
	var KEYCODE_G = 71;        
	var KEYCODE_H = 72;        
	var KEYCODE_J = 74;        
	var KEYCODE_Y = 89;        
	
	function player( id, xpos, img)   // img , xpos, playerkeys 
        {
            this.x = xpos;//*scale;
            this.y = 100;//*scale;
            this.id = id;
			//this.playerKeys = playerkeys;
            this.currentframe = 0;
            this.counter = 0;
            this.anim = anim_demo;
            this.health = 0;
            this.spriteSheet = img;
            this.frameX = 0;
            this.frameY = 0;
            this.spriteWidth = 0;
            this.spriteHeight = 0;
            this.nextAnim = anim_demo;
            this.step = function() {
                this.counter++;
                if(this.counter >= this.anim.length ) this.setAnim(this.nextAnim);
                this.frameX = this.spriteWidth * parseInt(this.anim[this.counter] % 7);
                this.frameY = this.spriteHeight * parseInt(this.anim[this.counter] / 7);
            }
            this.setAnim = function( nanim ) {
                this.counter = 0;
                this.anim = nanim;
                this.nextAnim = anim_idle;
            }
            this.initPlayer = function()
            {
                this.spriteWidth = parseInt(images[this.spriteSheet].width / 7);
                this.spriteHeight = parseInt(images[this.spriteSheet].height / 6);
                //numFrames = parseInt((images[spriteSheet].width / spriteWidth) *  (images[spriteSheet].width /spriteHeight)) - 2;
            }
			this.updatePlayer = function()
			{
				this.x = xpos;//*scale;
				this.y = 100;//*scale;
			}
			/*this.executeKey = function(keypress)
			{				
				for (var i=0; i<this.playerKeys.length; i++) {
					if (this.playerKeys[i] == keypress) {
						switch(i) {
							case 0:			// move left
                            this.x = this.x - 1;// (3*scale);		// console.log('LEFT ' + img);
								break;
							case 1:			// move right
                            this.x = this.x + 1;//+3*scale;
								break;
							case 2:			// move up
								break;
							case 3:			// move down
								break;
							case 4:			// fire
								break;
						}
					}
				}
			}*/
        }
        // screen size variables
		var scale = 1;
		var SCREEN_WIDTH, SCREEN_HEIGHT;
        
        var joystick = [0,0,0,0,0,0];
        var LEFT = 0x00001;
        var UP = 0x00010;
        var RIGHT = 0x00100;
        var DOWN = 0x01000;
        var BUTTONA = 0x10000;
        var UPRIGHT = (UP | RIGHT);
        var UPLEFT = (UP | LEFT);
        var DOWNRIGHT = (DOWN | RIGHT);
        var DOWNLEFT = (DOWN | LEFT);
        var LEFTA = (LEFT | BUTTONA);
        var RIGHTA = (RIGHT | BUTTONA);
        var UPA = (UP | BUTTONA);
        var DOWNA = (DOWN | BUTTONA);
        var UPRIGHTA = (UP | RIGHT | BUTTONA);
        var UPLEFTA = (UP | LEFT | BUTTONA);
        var DOWNRIGHTA = (DOWN | RIGHT | BUTTONA);
        var DOWNLEFTA = (DOWN | LEFT | BUTTONA);
        
        var canvas = document.createElement('canvas');
  		var c = canvas.getContext('2d');
        
		function screenUpdate() {
			SCREEN_WIDTH = window.innerWidth;
			SCREEN_HEIGHT = window.innerHeight;

			if (window.innerWidth / 320 < window.innerHeight / 200) {
				scale = window.innerWidth / 320;
			} else {
				scale = window.innerHeight / 200;		
			}
			
			canvas.width = 320 * scale;
			canvas.height = 200 * scale;
			canvas.style.position = "fixed";
			canvas.style.left = (SCREEN_WIDTH - canvas.width) / 2 + "px";
			canvas.style.top  = (SCREEN_HEIGHT - canvas.height) / 2 + "px";
			
			for (i = 0; i< players.length; i++){
				players[i].updatePlayer();
			}
            //var ctx=c.getContext("2d")
            c = canvas.getContext('2d');
            c.scale(scale,scale);
		}
 		
  		
		
		var index=0, 
			numFrames = 30, 
			gameState = 0,
            spriteFrame = 0,
            frameCounter = 0,
            frameTime = 0,
            splashDelay = 5;

 		
 		 // Add our drawing canvas
  		document.body.appendChild(canvas); 

   		//load the images
        var images = {};
		images[0] = new Image();
		images[0].src = "gfx/ikplayer_blue.png";
        images[1] = new Image();
		images[1].src = "gfx/ikplayer_red.png";
        images[2] = new Image();
		images[2].src = "gfx/ikplayer_white.png";
        
		iBack = new Image();
		iBack.src = "gfx/ikback.png";
        iSplash = new Image();
		iSplash.src = "gfx/iksplash.png";
        
        var players = [		// id, x pos, imageref, assigned keys
			new player(0,0,0),
			new player(1,60,1),
			new player(2,120,2),
			new player(3,180,1),
			new player(4,240,0)
		];
		// wait until everything is loaded before we 
		// start the animation

		screenUpdate();		
		window.addEventListener("load", init);
		window.onresize = screenUpdate;
		//window.onkeydown = handleKeyDown;
		//window.onkeyup = handleKeyUp;		
		
		function init(){
			//we're ready for the loop
            for (i = 0; i< players.length; i++){
                players[i].initPlayer();
            }
            //add touch listener
            var touchable = 'createTouch' in document;
            if(touchable) {
                canvas.addEventListener( 'touchstart', onTouchStart, false );
                canvas.addEventListener( 'touchmove', onTouchMove, false );
                canvas.addEventListener( 'touchend', onTouchEnd, false );
            }
            //add keyboard listener
            //var keyable = 'createTouch' in document;
            //if(touchable) {
            document.addEventListener( 'keydown', onKeyDown, false );
            document.addEventListener( 'keypress', onKeyPress, false );
            document.addEventListener( 'keyup', onKeyUp, false );
            //}
            // alert("Asso IK+");
            
			setInterval(loop, 1000 / 10);
		}
		function onKeyDown(event) {
            //do stuff
            event.preventDefault();
            switch( event.keyCode)
            {
                case KEYCODE_LEFT:  joystick[0]     |= LEFT;    break;
                case KEYCODE_UP:    joystick[0]     |= UP;      break;
                case KEYCODE_RIGHT: joystick[0]     |= RIGHT;   break;
                case KEYCODE_DOWN:  joystick[0]     |= DOWN;    break;
                case KEYCODE_SHIFT: joystick[0]     |= BUTTONA; break;
                case KEYCODE_A:     joystick[1]     |= LEFT;    break;
                case KEYCODE_W:     joystick[1]     |= UP;      break;
                case KEYCODE_D:     joystick[1]     |= RIGHT;   break;
                case KEYCODE_S:     joystick[1]     |= DOWN;    break;
                case KEYCODE_CTRL:  joystick[1]     |= BUTTONA; break;
                case KEYCODE_G:     joystick[2]     |= LEFT;    break;
                case KEYCODE_Y:     joystick[2]     |= UP;      break;
                case KEYCODE_J:     joystick[2]     |= RIGHT;   break;
                case KEYCODE_H:     joystick[2]     |= DOWN;    break;
                case KEYCODE_SPACE: joystick[2]     |= BUTTONA; break;
            }
        }
        
        function onKeyPress(event) {
            // Prevent the browser from doing its default thing (scroll, zoom)
            event.preventDefault(); 
        } 
        
        function onKeyUp(event) { 
            event.preventDefault();
            switch( event.keyCode)
            {
                case KEYCODE_LEFT:  joystick[0]     &= ~LEFT;   break;
                case KEYCODE_UP:    joystick[0]     &= ~UP;     break;
                case KEYCODE_RIGHT: joystick[0]     &= ~RIGHT;  break;
                case KEYCODE_DOWN:  joystick[0]     &= ~DOWN;   break;
                case KEYCODE_SHIFT: joystick[0]     &= ~BUTTONA;break;
                case KEYCODE_A:     joystick[1]     &= ~LEFT;   break;
                case KEYCODE_W:     joystick[1]     &= ~UP;     break;
                case KEYCODE_D:     joystick[1]     &= ~RIGHT;  break;
                case KEYCODE_S:     joystick[1]     &= ~DOWN;   break;
                case KEYCODE_CTRL:  joystick[1]     &= ~BUTTONA;break;
                case KEYCODE_G:     joystick[2]     &= ~LEFT;   break;
                case KEYCODE_Y:     joystick[2]     &= ~UP;     break;
                case KEYCODE_J:     joystick[2]     &= ~RIGHT;  break;
                case KEYCODE_H:     joystick[2]     &= ~DOWN;   break;
                case KEYCODE_SPACE: joystick[2]     &= ~BUTTONA;break;
            }
            //do stuff
            
        }
        function onTouchStart(event) {
            //do stuff
        }
        
        function onTouchMove(event) {
            // Prevent the browser from doing its default thing (scroll, zoom)
            event.preventDefault(); 
        } 
        
        function onTouchEnd(event) { 
            //do stuff
        }
    
	   	function input( iplayer) {
            switch( joystick[iplayer] )
            {
                case 0:         return anim_idle;
                case LEFT:      players[iplayer].x -= 1;return anim_walk;
                case RIGHT:     players[iplayer].x += 1;return anim_walk;
                case UP:        return anim_jump;
                case DOWN:      return anim_sweep;
                case UPRIGHT:   return anim_punch;
                case UPLEFT:    return anim_punch_back;      //backward
                case DOWNRIGHT: return anim_low_kick;
                case DOWNLEFT:  return anim_sit_punch;
                
                case BUTTONA:   return anim_idle;
                case LEFTA:     return anim_cartwheel;
                case RIGHTA:    return anim_kick;
                case UPA:       return anim_jumpkick;
                case DOWNA:     return anim_sweep_back;      //backward
                case UPRIGHTA:  return anim_headbutt;
                case UPLEFTA:   return anim_splitkick;
                case DOWNRIGHTA:return anim_kick_high;
                case DOWNLEFTA: return anim_kick_high_back;  //backward
                default: return anim_idle;
            }
        }

    
		function loop() {
            frameTime ++;
            frameCounter++;
            if(frameTime > splashDelay && gameState == 0) gameState = 1;
            
			/*our big long list of arguments below equates to
             1: our image source
             2 - 5: the rectangle in the source image of what we want to draw
             6 - 9: the  rectangle of our canvas that we are drawing into
             */
            switch(gameState)
            {
                case 0: //SPLASH
                //DRAW SPLASH
                c.drawImage(iSplash, 0, 0, iSplash.width, iSplash.height, 0, 0, iSplash.width, iSplash.height);
                break;
                case 1: //DEMO MODE
                //LOGIC
                
                
                //DRAW
                //c.clearRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
                c.drawImage(iBack, 0, 0, iBack.width, iBack.height, 0, 0, iBack.width, iBack.height);
                
                for (i = 0; i< players.length; i++){
                    players[i].step();

                    c.drawImage(images[players[i].spriteSheet], players[i].frameX , players[i].frameY , players[i].spriteWidth, players[i].spriteHeight, players[i].x , players[i].y , players[i].spriteWidth, players[i].spriteHeight);
                    players[i].nextAnim = anim_demo;
                }
                if(joystick[0] != 0) 
                {
                    gameState = 2;
                    for (i = 0; i< players.length; i++){
                        players[i].anim = anim_idle;
                        players[i].nextAnim = anim_idle;
                        players[i].counter = 0;
                        players[i].step();
                        players[i].counter = 0;
                    }
                    c.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);
                }
					c.fillStyle = "#fff";
					c.font = "" + 6 + "pt C64 Pro Mono";
					c.fillText("Hello World", (0),(7)+(25));
					break;
					
                case 2: // GAME ON!
                c.drawImage(iBack, 0, 0, iBack.width, iBack.height, 0, 0, iBack.width, iBack.height);
                // Logic it
                
                // Draw
                for (i = 0; i< players.length; i++){
                    players[i].nextAnim = input( i );
                    players[i].step();

                    c.drawImage(images[players[i].spriteSheet], players[i].frameX , players[i].frameY , players[i].spriteWidth, players[i].spriteHeight, players[i].x , players[i].y , players[i].spriteWidth, players[i].spriteHeight);
                }

                    break;
					
                default:
                    break;
            }
			
			
		}
    	
	
   		
	</script>
	please load font!
	</body>
	
</html>
